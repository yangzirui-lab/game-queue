var u=(o,t,e)=>new Promise((s,n)=>{var r=c=>{try{i(e.next(c))}catch(l){n(l)}},a=c=>{try{i(e.throw(c))}catch(l){n(l)}},i=c=>c.done?s(c.value):Promise.resolve(c.value).then(r,a);i((e=e.apply(o,t)).next())});const S="https://store.steampowered.com/api/storesearch/",$="https://store.steampowered.com/api/appdetails",y="https://store.steampowered.com/appreviews",m=["https://api.allorigins.win/raw?url=","https://corsproxy.io/?","https://api.codetabs.com/v1/proxy?quest="],p="https://degenerates.site",A=`${p}/api/auth/login/password`,w=`${p}/api/auth/logout`,U=`${p}/api/games`,G=o=>`${p}/api/games/${o}`,T=`${p}/api/games/search`,x=`${p}/api/users/me/games`,C=o=>`${p}/api/users/me/games/${o}`,O=o=>`${p}/api/users/me/games/${o}/status`,h="session_token",d="auth_user";function _(o,t){if(!o||o.trim()===""){console.error("[Auth] Cannot save auth data: Invalid token");return}if(!t||!t.id){console.error("[Auth] Cannot save auth data: Invalid user");return}localStorage.setItem(h,o),localStorage.setItem(d,JSON.stringify(t))}function v(){const o=localStorage.getItem(d);if(!o)return null;try{return JSON.parse(o)}catch(t){return console.error("[Auth] Failed to parse user data:",t),null}}function P(){return localStorage.getItem(h)}function E(){localStorage.removeItem(h),localStorage.removeItem(d)}function j(o){return u(this,null,function*(){try{const t=yield fetch(A,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});if(!t.ok){const s=yield t.json();return console.error(`[Auth] Login failed: ${t.status} - ${s.message}`),null}const e=yield t.json();return!e.data||!e.data.token||!e.data.user?(console.error("[Auth] Invalid response: missing token or user"),null):(_(e.data.token,e.data.user),console.log("[Auth] Login successful, token saved"),e.data.user)}catch(t){return console.error("[Auth] Error during login:",t),null}})}function k(){return u(this,null,function*(){const o=P();if(o)try{const t=yield fetch(w,{method:"POST",headers:{Authorization:`Bearer ${o}`}});t.ok||console.error(`[Auth] Failed to logout: ${t.status} ${t.statusText}`)}catch(t){console.error("[Auth] Error during logout:",t)}return E(),console.log("[Auth] Logout successful, token cleared"),!0})}function L(){return v()!==null}function D(){return v()}class I{fetchWithProxy(t,e){return u(this,null,function*(){for(let s=0;s<m.length;s++){const n=m[s];try{const r=`${n}${encodeURIComponent(t)}`,a=yield fetch(r,{method:"GET",headers:{Accept:"application/json"}});if(!a.ok){console.warn(`[SteamService] Proxy ${s+1}/${m.length} failed for ${e}: ${a.status}`);continue}return console.log(`[SteamService] Proxy ${s+1}/${m.length} succeeded for ${e}`),a}catch(r){console.error(`[SteamService] Proxy ${s+1}/${m.length} error for ${e}:`,r);continue}}return console.error(`[SteamService] All proxies failed for ${e}`),null})}search(t){return u(this,null,function*(){const{query:e}=t;if(!e.trim())return[];const s=`${S}?term=${encodeURIComponent(e)}&l=schinese&cc=CN`,n=yield this.fetchWithProxy(s,`search: ${e}`);if(!n)return null;try{const r=yield n.json();if(!r.items||r.items.length===0)return console.log("[SteamService] No items found in search response"),[];const a=r.items.filter(i=>i.type==="app").slice(0,10).map(i=>({id:i.id,name:i.name,steamUrl:`https://store.steampowered.com/app/${i.id}`,coverImage:i.tiny_image||`https://cdn.cloudflare.steamstatic.com/steam/apps/${i.id}/capsule_sm_120.jpg`,tags:[],positivePercentage:null,totalReviews:null,averagePlaytime:null,releaseDate:null,comingSoon:null,isEarlyAccess:null,genres:null}));return console.log(`[SteamService] Successfully found ${a.length} games`),a}catch(r){return console.error("[SteamService] Error parsing search response:",r),null}})}getGameDetails(t){return u(this,null,function*(){var r;const{appId:e}=t,s=`${$}?appids=${e}&l=schinese&cc=CN`,n=yield this.fetchWithProxy(s,`appdetails: ${e}`);if(!n)return null;try{const a=yield n.json();return(r=a[e])!=null&&r.success?a[e].data:(console.warn(`[SteamService] Steam API returned unsuccessful for app ${e}`),null)}catch(a){return console.error(`[SteamService] Error parsing appdetails response for ${e}:`,a),null}})}getGameReleaseDate(t){return u(this,null,function*(){var r,a,i,c,l;const{appId:e}=t,s=yield this.getGameDetails({appId:e});if(!s)return{releaseDate:null,comingSoon:null,isEarlyAccess:null,genres:null};const n=((r=s.genres)==null?void 0:r.some(g=>g.id==="70"))||!1;return console.log(`[SteamService] Game ${e} - isEarlyAccess: ${n}, genres:`,(a=s.genres)==null?void 0:a.map(g=>`${g.id}:${g.description}`).join(", ")),{releaseDate:((i=s.release_date)==null?void 0:i.date)||null,comingSoon:(l=(c=s.release_date)==null?void 0:c.coming_soon)!=null?l:null,isEarlyAccess:n,genres:s.genres||null}})}getGameReviews(t){return u(this,null,function*(){const{appId:e}=t,[s,n]=yield Promise.all([this.fetchReviewsByLanguage(e,"all"),this.fetchReviewsByLanguage(e,"schinese")]);return{positivePercentage:s.positivePercentage,totalReviews:s.totalReviews,chinesePositivePercentage:n.positivePercentage,chineseTotalReviews:n.totalReviews}})}fetchReviewsByLanguage(t,e){return u(this,null,function*(){const s=`${y}/${t}?json=1&language=${e}&purchase_type=all&num_per_page=0`,n=yield this.fetchWithProxy(s,`reviews: ${t} (${e})`);if(!n)return{positivePercentage:null,totalReviews:null};try{const r=yield n.json();if(!r.query_summary)return console.warn(`[SteamService] No query_summary in reviews response for app ${t} (${e})`),{positivePercentage:null,totalReviews:null};const{total_positive:a,total_negative:i,total_reviews:c}=r.query_summary;let l=null;const g=c||null;if(a!==void 0&&i!==void 0){const f=a+i;f>0&&(l=Math.round(a/f*100))}return{positivePercentage:l,totalReviews:g}}catch(r){return console.error(`[SteamService] Error parsing reviews response for ${t} (${e}):`,r),{positivePercentage:null,totalReviews:null}}})}}const N=new I;export{U as G,x as U,T as a,G as b,O as c,C as d,D as e,k as f,P as g,L as i,j as l,N as s};
